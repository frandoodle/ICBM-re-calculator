summarise_all(mean) %>%
summarise_all(mean) %>%
pivot_longer(c("soc_30cm_naive", "soc_30cm_dynamic_control"), names_to="soc_method", values_to="soc") %>%
pivot_longer(c("initial_dsm", "initial_cmods"), names_to="initial_method", values_to="initial") %>%
ggplot(aes(x=year_name, y=soc_30cm_naive)) +
geom_segment(data=ellerslie_increase, aes(y=initial_dsm, x=initial_soc_year, yend=first_soc, xend=first_soc_year), color="red",
arrow = arrow(length = unit(0.1, "inches"))) +
geom_text(data=ellerslie_increase, aes(x=first_soc_year, y=first_soc, hjust=ifelse(first_soc_year < 1990, -0.1, 1.1), label=paste0(sign,round(increase_per_year, 2)," Mg/ha/yr\n",sign,round(fraction_increase_per_year,2)*100, "%/yr")),
color="red") +
geom_segment(data=ellerslie_increase, aes(y=initial_dsm, x=recommended_initial_soc_year, yend=first_soc, xend=first_soc_year), color="blue",
arrow = arrow(length = unit(0.1, "inches"))) +
geom_text(data=ellerslie_increase, aes(x=recommended_initial_soc_year, y=initial_dsm, label=paste0(sign,round(recommended_increase_per_year, 2)," Mg/ha/yr\n",sign,round(recommended_fraction_increase_per_year,2)*100, "%/yr")),
color="blue", hjust=-0.1, vjust=0) +
geom_point(aes(y=soc, color=soc_method), alpha=0.7) +
geom_point(aes(y=initial, shape=initial_method, x=initial_soc_year), color="red") +
theme_bw() +
facet_wrap(vars(treatment_name)) +
ylab("SOC (Mg/ha)") +
xlab("Year") +
ggtitle("Ellerslie") +
theme(aspect.ratio = 1)
harrow_increase <- site_data_all_joined %>%
filter(location_name == "Harrow") %>%
group_by_all() %>%
summarise_all(mean) %>%
summarise_all(mean) %>%
group_by(treatment_name) %>%
mutate(first_soc = first(soc_30cm_naive),
first_soc_year = first(year_name)) %>%
select(treatment_name, first_soc, first_soc_year, initial_dsm, initial_soc_year) %>%
unique %>%
mutate(increase = first_soc - initial_dsm,
increase_per_year = increase / (first_soc_year - initial_soc_year),
fraction_increase = increase/initial_dsm,
fraction_increase_per_year = fraction_increase / (first_soc_year - initial_soc_year),
sign = ifelse(fraction_increase_per_year<0, "-", "+"))
site_data_all_joined %>%
filter(location_name == "Harrow") %>%
# Get mean values between replicates and soil depth measurements. Lethbridge requires a particularly difficult grouping scheme
group_by_all() %>%
summarise_all(mean) %>%
summarise_all(mean) %>%
pivot_longer(c("soc_30cm_naive", "soc_30cm_dynamic_control"), names_to="soc_method", values_to="soc") %>%
pivot_longer(c("initial_dsm", "initial_cmods"), names_to="initial_method", values_to="initial") %>%
ggplot(aes(x=year_name, y=soc_30cm_naive)) +
geom_segment(data=harrow_increase, aes(y=initial_dsm, x=initial_soc_year, yend=first_soc, xend=first_soc_year), color="red",
arrow = arrow(length = unit(0.1, "inches"))) +
geom_text(data=harrow_increase, aes(x=first_soc_year, y=first_soc, hjust=ifelse(first_soc_year < 1990, -0.1, 1.1), label=paste0(sign,round(increase_per_year, 2)," Mg/ha/yr\n",sign,round(fraction_increase_per_year,2)*100, "%/yr")),
color="red") +
geom_point(aes(y=soc, color=soc_method), alpha=0.7) +
geom_point(aes(y=initial, shape=initial_method, x=initial_soc_year), color="red") +
theme_bw() +
facet_wrap(vars(treatment_name)) +
ylab("SOC (Mg/ha)") +
xlab("Year") +
ggtitle("Harrow") +
theme(aspect.ratio = 1)
lethbridge_increase <- site_data_all_joined %>%
filter(location_name == "Lethbridge") %>%
group_by_all() %>%
summarise_all(mean) %>%
summarise_all(mean) %>%
group_by(treatment_name) %>%
mutate(first_soc = first(soc_30cm_naive),
first_soc_year = first(year_name)) %>%
select(treatment_name, first_soc, first_soc_year, initial_dsm, initial_soc_year) %>%
unique %>%
mutate(increase = first_soc - initial_dsm,
increase_per_year = increase / (first_soc_year - initial_soc_year),
fraction_increase = increase/initial_dsm,
fraction_increase_per_year = fraction_increase / (first_soc_year - initial_soc_year),
sign = ifelse(fraction_increase_per_year<0, "-", "+"))
site_data_all_joined %>%
filter(location_name == "Lethbridge") %>%
# Get mean values between replicates and soil depth measurements. Lethbridge requires a particularly difficult grouping scheme
group_by_all() %>%
summarise_all(mean) %>%
summarise_all(mean) %>%
pivot_longer(c("soc_30cm_naive", "soc_30cm_dynamic_control"), names_to="soc_method", values_to="soc") %>%
pivot_longer(c("initial_dsm", "initial_cmods"), names_to="initial_method", values_to="initial") %>%
ggplot(aes(x=year_name, y=soc_30cm_naive)) +
geom_segment(data=lethbridge_increase, aes(y=initial_dsm, x=initial_soc_year, yend=first_soc, xend=first_soc_year), color="red",
arrow = arrow(length = unit(0.1, "inches"))) +
geom_text(data=lethbridge_increase, aes(x=first_soc_year, y=first_soc, hjust=ifelse(first_soc_year < 1990, -0.1, 1.1), label=paste0(sign,round(increase_per_year, 2)," Mg/ha/yr\n",sign,round(fraction_increase_per_year,2)*100, "%/yr")),
color="red") +
geom_point(aes(y=soc, color=soc_method), alpha=0.7) +
geom_point(aes(y=initial, shape=initial_method, x=initial_soc_year), color="red") +
theme_bw() +
facet_wrap(vars(treatment_name)) +
ylab("SOC (Mg/ha)") +
xlab("Year") +
ggtitle("Lethbridge") +
theme(aspect.ratio = 1)
ottawa_increase <- site_data_all_joined %>%
filter(location_name == "Ottawa") %>%
group_by(treatment_name) %>%
mutate(first_soc = first(soc_30cm_naive),
first_soc_year = first(year_name)) %>%
select(treatment_name, first_soc, first_soc_year, initial_dsm, initial_soc_year) %>%
unique %>%
mutate(increase = first_soc - initial_dsm,
increase_per_year = increase / (first_soc_year - initial_soc_year),
fraction_increase = increase/initial_dsm,
fraction_increase_per_year = fraction_increase / (first_soc_year - initial_soc_year),
sign = ifelse(fraction_increase_per_year<0, "-", "+"),
recommended_initial_soc_year = initial_soc_year-10,
recommended_increase_per_year = increase / (first_soc_year - recommended_initial_soc_year),
recommended_fraction_increase_per_year = recommended_increase_per_year/initial_dsm)
site_data_all_joined %>%
filter(location_name == "Ottawa") %>%
pivot_longer(c("soc_30cm_naive", "soc_30cm_dynamic_control"), names_to="soc_method", values_to="soc") %>%
pivot_longer(c("initial_dsm", "initial_cmods"), names_to="initial_method", values_to="initial") %>%
ggplot(aes(x=year_name, y=soc_30cm_naive)) +
geom_segment(data=ottawa_increase, aes(y=initial_dsm, x=initial_soc_year, yend=first_soc, xend=first_soc_year), color="red",
arrow = arrow(length = unit(0.1, "inches"))) +
geom_text(data=ottawa_increase, aes(x=first_soc_year, y=first_soc, label=paste0(sign,round(increase_per_year, 2)," Mg/ha/yr\n",sign,round(fraction_increase_per_year,2)*100, "%/yr")),
color="red", hjust=-0.1) +
geom_segment(data=ottawa_increase, aes(y=initial_dsm, x=recommended_initial_soc_year, yend=first_soc, xend=first_soc_year), color="blue",
arrow = arrow(length = unit(0.1, "inches"))) +
geom_text(data=ottawa_increase, aes(x=recommended_initial_soc_year, y=initial_dsm, label=paste0(sign,round(recommended_increase_per_year, 2)," Mg/ha/yr\n",sign,round(recommended_fraction_increase_per_year,2)*100, "%/yr")),
color="blue", hjust=-0.1, vjust=0) +
geom_point(aes(y=soc, color=soc_method), alpha=0.7) +
geom_point(aes(y=initial, shape=initial_method, x=initial_soc_year), color="red") +
theme_bw() +
facet_wrap(vars(treatment_name)) +
ylab("SOC (Mg/ha)") +
xlab("Year") +
ggtitle("Ottawa") +
theme(aspect.ratio = 1)
scott_increase <- site_data_all_joined %>%
filter(location_name == "Scott") %>%
group_by_all() %>%
summarise_all(mean) %>%
group_by(treatment_name) %>%
mutate(first_soc = first(soc_30cm_naive),
first_soc_year = first(year_name)) %>%
select(treatment_name, first_soc, first_soc_year, initial_dsm, initial_soc_year) %>%
unique %>%
mutate(increase = first_soc - initial_dsm,
increase_per_year = increase / (first_soc_year - initial_soc_year),
fraction_increase = increase/initial_dsm,
fraction_increase_per_year = fraction_increase / (first_soc_year - initial_soc_year),
sign = ifelse(fraction_increase_per_year<0, "-", "+"),
recommended_initial_soc_year = initial_soc_year-15,
recommended_increase_per_year = increase / (first_soc_year - recommended_initial_soc_year),
recommended_fraction_increase_per_year = recommended_increase_per_year/initial_dsm)
site_data_all_joined %>%
filter(location_name == "Scott") %>%
group_by_all() %>%
summarise_all(mean) %>%
pivot_longer(c("soc_30cm_naive", "soc_30cm_dynamic_control"), names_to="soc_method", values_to="soc") %>%
pivot_longer(c("initial_dsm", "initial_cmods"), names_to="initial_method", values_to="initial") %>%
ggplot(aes(x=year_name, y=soc_30cm_naive)) +
geom_segment(data=scott_increase, aes(y=initial_dsm, x=initial_soc_year, yend=first_soc, xend=first_soc_year), color="red",
arrow = arrow(length = unit(0.1, "inches"))) +
geom_text(data=scott_increase, aes(x=first_soc_year, y=first_soc, label=paste0(sign,round(increase_per_year, 2)," Mg/ha/yr\n",sign,round(fraction_increase_per_year,2)*100, "%/yr")),
color="red", hjust=-0.1, size=3) +
geom_segment(data=scott_increase, aes(y=initial_dsm, x=recommended_initial_soc_year, yend=first_soc, xend=first_soc_year), color="blue",
arrow = arrow(length = unit(0.1, "inches"))) +
geom_text(data=scott_increase, aes(x=recommended_initial_soc_year, y=initial_dsm, label=paste0(sign,round(recommended_increase_per_year, 2)," Mg/ha/yr\n",sign,round(recommended_fraction_increase_per_year,2)*100, "%/yr")),
color="blue", hjust=-0.1, vjust=0, size=3) +
geom_point(aes(y=soc, color=soc_method), alpha=0.7) +
geom_point(aes(y=initial, shape=initial_method, x=initial_soc_year), color="red") +
theme_bw() +
facet_wrap(vars(treatment_name)) +
ylab("SOC (Mg/ha)") +
xlab("Year") +
ggtitle("Scott") +
theme(aspect.ratio = 1)
site_data_all_joined %>%
filter(location_name == "Scott") %>%
group_by_all() %>%
summarise_all(mean) %>%
pivot_longer(c("soc_30cm_naive", "soc_30cm_dynamic_control"), names_to="soc_method", values_to="soc") %>%
pivot_longer(c("initial_dsm", "initial_cmods"), names_to="initial_method", values_to="initial") %>%
ggplot(aes(x=year_name, y=soc_30cm_naive)) +
geom_segment(data=scott_increase, aes(y=initial_dsm, x=initial_soc_year, yend=first_soc, xend=first_soc_year), color="red",
arrow = arrow(length = unit(0.1, "inches"))) +
geom_text(data=scott_increase, aes(x=first_soc_year, y=first_soc, label=paste0(sign,round(increase_per_year, 2)," Mg/ha/yr\n",sign,round(fraction_increase_per_year,2)*100, "%/yr")),
color="red", hjust=-0.1, size=3) +
geom_segment(data=scott_increase, aes(y=initial_dsm, x=recommended_initial_soc_year, yend=first_soc, xend=first_soc_year), color="blue",
arrow = arrow(length = unit(0.1, "inches"))) +
geom_text(data=scott_increase, aes(x=recommended_initial_soc_year, y=initial_dsm, label=paste0(sign,round(recommended_increase_per_year, 2)," Mg/ha/yr\n",sign,round(recommended_fraction_increase_per_year,2)*100, "%/yr")),
color="blue", hjust=-0.1, vjust=0, size=3) +
geom_point(aes(y=soc, color=soc_method), alpha=0.7) +
geom_point(aes(y=initial, shape=initial_method, x=initial_soc_year), color="red") +
theme_bw() +
facet_grid(vars(Exp_ID, treatment_name)) +
ylab("SOC (Mg/ha)") +
xlab("Year") +
ggtitle("Scott") +
theme(aspect.ratio = 1)
site_data_corrected <- site_data_all %>%
select(Exp_ID, location_name, treatment_number,treatment_name, year_name, replication_number, soil_depth, soil_depth_min_cm, soil_depth_max_cm,
soc_tha, initial_soc_tha, initial_soc_year) %>%
filter(!is.na(soc_tha)) %>%
# Get the mean for field_name, replication_number, and block
group_by(Exp_ID, location_name, year_name, treatment_number, treatment_name, soil_depth_min_cm, soil_depth_max_cm) %>%
summarise(across(soc_tha:initial_soc_tha, mean)) %>%
# Find bottom 10cm of soil profile SOC using control from that treatment
mutate(f_control = (abs(20-soil_depth_min_cm) +  abs(30-soil_depth_max_cm)),
f_control_depth = soil_depth_max_cm - soil_depth_min_cm) %>%
group_by(Exp_ID, year_name) %>%
mutate(soc_tha_control = ifelse(1 %in% treatment_number,
filter(cur_data(),
treatment_number==1,
f_control == min(cur_data()$f_control))$soc_tha,
# If a control treatment is not indicated by treatment_number = 1, just use the first row in group
slice(cur_data(),1)$soc_tha),
soc_tha_10cm_control = ifelse(1 %in% treatment_number,
soc_tha_control*(10/(filter(cur_data(),
treatment_number==1,
f_control == min(f_control))$f_control_depth)),
slice(cur_data(),1)$f_control_depth)) %>%
# Compute the total measured depth (only including depths < 20cm) for each treatment, use this to estimate 0-20cm SOC
group_by(Exp_ID, location_name, treatment_number, treatment_name, year_name) %>%
mutate(soc_tha_30cm = soc_tha*(30/(soil_depth_max_cm-soil_depth_min_cm))) %>%
summarise(lowest_depth = -sum(-soil_depth_max_cm[soil_depth_max_cm<=20], soil_depth_min_cm[soil_depth_max_cm<=20]),
soc_lowestdepth_dynamic = sum(soc_tha[soil_depth_max_cm<=20]),
soc_30cm_naive = mean(soc_tha_30cm),
soc_10cm_control = mean(soc_tha_10cm_control)) %>%
mutate(soc_20cm_dynamic = soc_lowestdepth_dynamic*(20/lowest_depth),
soc_20cm_naive = soc_30cm_naive*(20/30),
soc_30cm_dynamic_control = soc_20cm_dynamic + soc_10cm_control,
soc_30cm_naive_control = soc_20cm_naive + soc_10cm_control)
library(ggplot2)
library(dplyr)
library(here)
library(stringr)
library(tidyr)
dir.create(tempdir()) #This fixes a bug if the temporary directory is not found
here::i_am("qc_initialc.rmd")
#site_data_all <- readr::read_csv(here("data/all_experiments_dummy.csv")) %>%
site_data_all <- readr::read_csv(here("data/lte_master_beta_dec02.csv")) %>%
mutate(soil_depth = paste0(soil_depth_min_cm,"-",soil_depth_max_cm))
site_data_control_comparison <- site_data_all %>%
mutate(is_control = ifelse(treatment_number == 1, TRUE, FALSE)) %>%
group_by(Exp_ID, is_control, soil_depth) %>%
summarise(soc = mean(soc_tha, na.rm=T), sd = sd(soc_tha, na.rm=T)) %>%
mutate(soc_upper = soc+sd,
soc_lower = soc-sd) %>%
filter(!is.na(is_control)) %>%
filter(!is.na(soc))
site_data_control_comparison
# Lethbridge is the only site with both control and non-control treatments
# (Control meaning treatment_number == 1)
site_data_control_comparison %>%
filter(Exp_ID == 4) %>%
ggplot(aes(y=soc, x=soil_depth, fill=is_control)) +
facet_wrap(vars(Exp_ID)) +
geom_col(position="dodge") +
geom_errorbar(aes(ymin = soc_lower, ymax = soc_upper), position="dodge")
site_data_corrected <- site_data_all %>%
select(Exp_ID, location_name, treatment_number,treatment_name, year_name, replication_number, soil_depth, soil_depth_min_cm, soil_depth_max_cm,
soc_tha, initial_soc_tha, initial_soc_year) %>%
filter(!is.na(soc_tha)) %>%
# Get the mean for field_name, replication_number, and block
group_by(Exp_ID, location_name, year_name, treatment_number, treatment_name, soil_depth_min_cm, soil_depth_max_cm) %>%
summarise(across(soc_tha:initial_soc_tha, mean)) %>%
# Find bottom 10cm of soil profile SOC using control from that treatment
mutate(f_control = (abs(20-soil_depth_min_cm) +  abs(30-soil_depth_max_cm)),
f_control_depth = soil_depth_max_cm - soil_depth_min_cm) %>%
group_by(Exp_ID, year_name) %>%
mutate(soc_tha_control = ifelse(1 %in% treatment_number,
filter(cur_data(),
treatment_number==1,
f_control == min(cur_data()$f_control))$soc_tha,
# If a control treatment is not indicated by treatment_number = 1, just use the first row in group
slice(cur_data(),1)$soc_tha),
soc_tha_10cm_control = ifelse(1 %in% treatment_number,
soc_tha_control*(10/(filter(cur_data(),
treatment_number==1,
f_control == min(f_control))$f_control_depth)),
slice(cur_data(),1)$f_control_depth)) %>%
# Compute the total measured depth (only including depths < 20cm) for each treatment, use this to estimate 0-20cm SOC
group_by(Exp_ID, location_name, treatment_number, treatment_name, year_name) %>%
mutate(soc_tha_30cm = soc_tha*(30/(soil_depth_max_cm-soil_depth_min_cm))) %>%
summarise(lowest_depth = -sum(-soil_depth_max_cm[soil_depth_max_cm<=20], soil_depth_min_cm[soil_depth_max_cm<=20]),
soc_lowestdepth_dynamic = sum(soc_tha[soil_depth_max_cm<=20]),
soc_30cm_naive = mean(soc_tha_30cm),
soc_10cm_control = mean(soc_tha_10cm_control)) %>%
mutate(soc_20cm_dynamic = soc_lowestdepth_dynamic*(20/lowest_depth),
soc_20cm_naive = soc_30cm_naive*(20/30),
soc_30cm_dynamic_control = soc_20cm_dynamic + soc_10cm_control,
soc_30cm_naive_control = soc_20cm_naive + soc_10cm_control)
site_data_corrected %>%
select(Exp_ID, location_name, treatment_name, year_name,
soc_30cm_naive, soc_30cm_dynamic_control
) %>%
filter(location_name == "Ellerslie") %>%
filter(!is.na(soc_30cm_naive)) %>%
filter(treatment_number == 1 |
treatment_name == "F25NS")
site_data_corrected %>%
select(Exp_ID, location_name, treatment_name, year_name,
soc_30cm_naive, soc_30cm_dynamic_control
) %>%
filter(location_name == "Ellerslie") %>%
filter(!is.na(soc_30cm_naive)) %>%
filter(treatment_number == 1 |
treatment_name == "F25NS",
year_name == 2009)
site_data_corrected %>%
select(Exp_ID, location_name, treatment_name, year_name,
soc_30cm_naive, soc_30cm_dynamic_control
) %>%
filter(location_name == "Lethbridge") %>%
filter(!is.na(soc_30cm_naive)) %>%
filter(treatment_number == 1 |
treatment_name == "Fw-Wt I")
site_data_corrected %>%
select(Exp_ID, location_name, treatment_name, year_name,
soc_30cm_naive, soc_30cm_dynamic_control
) %>%
filter(location_name == "Lethbridge") %>%
filter(!is.na(soc_30cm_naive)) %>%
filter(treatment_number == 1 |
treatment_name == "Fw-Wt I",
year_name == 1992)
initialc_dsm <- readr::read_csv(here("data/lte_soc_30_cm_dsm.csv")) %>%
mutate(location_name = location_n)
initialc_cmods <- readr::read_csv(here("data/ExptSiteList.csv"))
site_data_all_joined <- full_join(site_data_corrected, initialc_dsm, by="location_name") %>%
full_join(initialc_cmods, by="location_name") %>%
select(location_name,
initial_dsm = `Can_SOC30 (Mg ha-1)`, initial_cmods = init_soc, initial_soc_year,
treatment_name,
year_name,
soc_30cm_naive, soc_30cm_dynamic_control) %>%
group_by(location_name, treatment_name) %>%
# Set the initial C to either be 1 year before the first year in the experiment, or 1999 (maximum start date).
mutate(initial_soc_year = ifelse(first(year_name) < 2000, first(year_name)-1, 1999)) %>%
filter(!is.na(soc_30cm_naive))
library(ggplot2)
library(dplyr)
library(here)
library(stringr)
library(tidyr)
dir.create(tempdir()) #This fixes a bug if the temporary directory is not found
here::i_am("qc_initialc.rmd")
#site_data_all <- readr::read_csv(here("data/all_experiments_dummy.csv")) %>%
site_data_all <- readr::read_csv(here("data/lte_master_beta_dec02.csv")) %>%
mutate(soil_depth = paste0(soil_depth_min_cm,"-",soil_depth_max_cm))
site_data_control_comparison <- site_data_all %>%
mutate(is_control = ifelse(treatment_number == 1, TRUE, FALSE)) %>%
group_by(Exp_ID, is_control, soil_depth) %>%
summarise(soc = mean(soc_tha, na.rm=T), sd = sd(soc_tha, na.rm=T)) %>%
mutate(soc_upper = soc+sd,
soc_lower = soc-sd) %>%
filter(!is.na(is_control)) %>%
filter(!is.na(soc))
site_data_control_comparison
# Lethbridge is the only site with both control and non-control treatments
# (Control meaning treatment_number == 1)
site_data_control_comparison %>%
filter(Exp_ID == 4) %>%
ggplot(aes(y=soc, x=soil_depth, fill=is_control)) +
facet_wrap(vars(Exp_ID)) +
geom_col(position="dodge") +
geom_errorbar(aes(ymin = soc_lower, ymax = soc_upper), position="dodge")
site_data_corrected <- site_data_all %>%
select(Exp_ID, location_name, treatment_number,treatment_name, year_name, replication_number, soil_depth, soil_depth_min_cm, soil_depth_max_cm,
soc_tha, initial_soc_tha, initial_soc_year) %>%
filter(!is.na(soc_tha)) %>%
# Get the mean for field_name, replication_number, and block
group_by(Exp_ID, location_name, year_name, treatment_number, treatment_name, soil_depth_min_cm, soil_depth_max_cm) %>%
group_by(.add=T, initial_soc_year) %>%
summarise(across(soc_tha:initial_soc_tha, mean)) %>%
# Find bottom 10cm of soil profile SOC using control from that treatment
mutate(f_control = (abs(20-soil_depth_min_cm) +  abs(30-soil_depth_max_cm)),
f_control_depth = soil_depth_max_cm - soil_depth_min_cm) %>%
group_by(Exp_ID, year_name) %>%
mutate(soc_tha_control = ifelse(1 %in% treatment_number,
filter(cur_data(),
treatment_number==1,
f_control == min(cur_data()$f_control))$soc_tha,
# If a control treatment is not indicated by treatment_number = 1, just use the first row in group
slice(cur_data(),1)$soc_tha),
soc_tha_10cm_control = ifelse(1 %in% treatment_number,
soc_tha_control*(10/(filter(cur_data(),
treatment_number==1,
f_control == min(f_control))$f_control_depth)),
slice(cur_data(),1)$f_control_depth)) %>%
# Compute the total measured depth (only including depths < 20cm) for each treatment, use this to estimate 0-20cm SOC
group_by(Exp_ID, location_name, treatment_number, treatment_name, year_name) %>%
group_by(.add=T, initial_soc_tha, initial_soc_year) %>%
mutate(soc_tha_30cm = soc_tha*(30/(soil_depth_max_cm-soil_depth_min_cm))) %>%
summarise(lowest_depth = -sum(-soil_depth_max_cm[soil_depth_max_cm<=20], soil_depth_min_cm[soil_depth_max_cm<=20]),
soc_lowestdepth_dynamic = sum(soc_tha[soil_depth_max_cm<=20]),
soc_30cm_naive = mean(soc_tha_30cm),
soc_10cm_control = mean(soc_tha_10cm_control)) %>%
mutate(soc_20cm_dynamic = soc_lowestdepth_dynamic*(20/lowest_depth),
soc_20cm_naive = soc_30cm_naive*(20/30),
soc_30cm_dynamic_control = soc_20cm_dynamic + soc_10cm_control,
soc_30cm_naive_control = soc_20cm_naive + soc_10cm_control)
site_data_corrected %>%
select(Exp_ID, location_name, treatment_name, year_name,
soc_30cm_naive, soc_30cm_dynamic_control
) %>%
filter(location_name == "Ellerslie") %>%
filter(!is.na(soc_30cm_naive)) %>%
filter(treatment_number == 1 |
treatment_name == "F25NS")
site_data_corrected %>%
select(Exp_ID, location_name, treatment_name, year_name,
soc_30cm_naive, soc_30cm_dynamic_control
) %>%
filter(location_name == "Ellerslie") %>%
filter(!is.na(soc_30cm_naive)) %>%
filter(treatment_number == 1 |
treatment_name == "F25NS",
year_name == 2009)
site_data_corrected %>%
select(Exp_ID, location_name, treatment_name, year_name,
soc_30cm_naive, soc_30cm_dynamic_control
) %>%
filter(location_name == "Lethbridge") %>%
filter(!is.na(soc_30cm_naive)) %>%
filter(treatment_number == 1 |
treatment_name == "Fw-Wt I")
site_data_corrected %>%
select(Exp_ID, location_name, treatment_name, year_name,
soc_30cm_naive, soc_30cm_dynamic_control
) %>%
filter(location_name == "Lethbridge") %>%
filter(!is.na(soc_30cm_naive)) %>%
filter(treatment_number == 1 |
treatment_name == "Fw-Wt I",
year_name == 1992)
initialc_dsm <- readr::read_csv(here("data/lte_soc_30_cm_dsm.csv")) %>%
mutate(location_name = location_n)
initialc_cmods <- readr::read_csv(here("data/ExptSiteList.csv"))
site_data_all_joined <- full_join(site_data_corrected, initialc_dsm, by="location_name") %>%
full_join(initialc_cmods, by="location_name") %>%
select(location_name,
initial_dsm = `Can_SOC30 (Mg ha-1)`, initial_cmods = init_soc, initial_soc_year,
treatment_name,
year_name,
soc_30cm_naive, soc_30cm_dynamic_control) %>%
group_by(location_name, treatment_name) %>%
# Set the initial C to either be 1 year before the first year in the experiment, or 1999 (maximum start date).
mutate(initial_soc_year = ifelse(first(year_name) < 2000, first(year_name)-1, 1999)) %>%
filter(!is.na(soc_30cm_naive))
site_data_all_joined
site_data_all_joined %>%
pivot_longer(c("soc_30cm_naive", "soc_30cm_dynamic_control"), names_to="soc_method", values_to="soc") %>%
pivot_longer(c("initial_dsm", "initial_cmods"), names_to="initial_method", values_to="initial") %>%
ggplot(aes(x=year_name)) +
geom_point(aes(y=soc, color=soc_method), alpha=0.4) +
geom_point(aes(y=initial, shape=initial_method, x=initial_soc_year), color="red") +
theme_bw() +
facet_wrap(vars(location_name)) +
ylab("SOC (Mg/ha)") +
xlab("Year") +
theme(aspect.ratio = 1)
# Lethbridge is the only site with both control and non-control treatments
# (Control meaning treatment_number == 1)
site_data_control_comparison %>%
filter(Exp_ID == 4) %>%
ggplot(aes(y=soc, x=soil_depth, fill=is_control)) +
facet_wrap(vars(Exp_ID)) +
geom_col(position="dodge") +
geom_errorbar(aes(ymin = soc_lower, ymax = soc_upper), position="dodge") +
theme_bw()
# Lethbridge is the only site with both control and non-control treatments
# (Control meaning treatment_number == 1)
site_data_control_comparison %>%
#filter(Exp_ID == 4) %>%
ggplot(aes(y=soc, x=soil_depth, fill=is_control)) +
facet_wrap(vars(Exp_ID)) +
geom_col(position="dodge") +
geom_errorbar(aes(ymin = soc_lower, ymax = soc_upper), position="dodge") +
theme_bw()
# Lethbridge is the only site with both control and non-control treatments
# (Control meaning treatment_number == 1)
site_data_control_comparison %>%
filter(Exp_ID == 4) %>%
ggplot(aes(y=soc, x=soil_depth, fill=is_control)) +
facet_wrap(vars(Exp_ID)) +
geom_col(position="dodge") +
geom_errorbar(aes(ymin = soc_lower, ymax = soc_upper), position="dodge") +
theme_bw()
# Lethbridge is the only site with both control and non-control treatments
# (Control meaning treatment_number == 1)
site_data_control_comparison %>%
filter(location_name == "Lethbridge, saskatchewan") %>%
ggplot(aes(y=soc, x=soil_depth, fill=is_control)) +
facet_wrap(vars(Exp_ID)) +
geom_col(position="dodge") +
geom_errorbar(aes(ymin = soc_lower, ymax = soc_upper), position="dodge") +
theme_bw()
# Lethbridge is the only site with both control and non-control treatments
# (Control meaning treatment_number == 1)
site_data_control_comparison %>%
filter(Exp_ID == 4) %>%
ggplot(aes(y=soc, x=soil_depth, fill=is_control)) +
#facet_wrap(vars(Exp_ID)) +
geom_col(position="dodge") +
geom_errorbar(aes(ymin = soc_lower, ymax = soc_upper), position="dodge") +
ggtitle("Lethbridge") +
theme_bw()
site_data_all_joined %>%
pivot_longer(c("soc_30cm_naive", "soc_30cm_dynamic_control"), names_to="soc_method", values_to="soc") %>%
pivot_longer(c("initial_dsm", "initial_cmods"), names_to="initial_method", values_to="initial") %>%
ggplot(aes(x=year_name)) +
geom_point(aes(y=soc, color=soc_method), alpha=0.4) +
geom_point(aes(y=initial, shape=initial_method, x=initial_soc_year), color="red") +
theme_bw() +
facet_wrap(vars(location_name)) +
ylab("SOC (Mg/ha)") +
xlab("Year") +
theme(aspect.ratio = 1)
