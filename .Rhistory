map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
sitedata_ex_multiplesite[20:23] %>%
map(~head(.,3))
result_ex_multiplesite <- sitedata_ex_multiplesite %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
result_ex_multiplesite[20:23] %>%
map(~head(.,3))
sitedata_ex_error1 <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
group_by(location_name) %>%
group_split
try(sitedata_ex_error1 %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0)))
sitedata_ex_error1 %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_multiplesite %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_error2 <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
group_by(team_name, location_name, treatment_name, replication_number) %>%
group_split
sitedata_ex_error2 %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_depth <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
mutate(soil_depth = paste0(soil_depth_min_cm,"-",soil_depth_max_cm)) %>%
group_by(team_name, location_name, treatment_name, replication_number, plot_id, soil_depth) %>%
group_split
sitedata_ex_depth %>%
map(~any(duplicated(.$year_name))) %>%
unlist
result_ex_depth <- sitedata_ex_depth[1:10] %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
result_ex_depth
result_ex_multipletrmt <- sitedata_ex_multipletrmt %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0,
# overrides
hag = 0.1))
result_ex_multipletrmt
param_bounds <- read.csv(here("data/ipcct2_parameters_gsa.csv"), stringsAsFactors = FALSE)
sa_results <- gsa(sitedata_ex_onesite,
climate_data,
param_bounds)
sa_results
ex_func <- function(parameters) {
parameters["x"] + parameters["y"]
}
optim(par = c(x=-1.2,y=1), fn = ex_func, method = "L-BFGS-B", lower = c(x=0,y=1), upper = c(x=1,y=5))
icbm_wrapper_example <- function(parameters,
DailyClimateTable,
SiteDataTable,
ag_init = 0,
bg_init = 0,
o_init = 0,
...) {
args <- list(...)
inputs <- list(DailyClimateTable = DailyClimateTable,
SiteDataTable = SiteDataTable,
ag_init = ag_init,
bg_init = bg_init,
o_init = o_init) %>%
append(args) %>%
append(as.list(parameters))
model_results <- do.call(run_icbm,inputs)
mean_re <- mean(bind_rows(model_results)$re)
print(paste0(names(parameters),": ",parameters))
print(paste0("mean_re: ",mean_re))
return(mean_re)
}
icbm_wrapper_example(
parameters = c(r_c = 1),
SiteDataTable = sitedata_ex_multipletrmt[[1]],
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0
)
optim(par = c(r_c = 0.5), fn = icbm_wrapper_example, method = "L-BFGS-B", lower = c(r_c = 0), upper = c(r_c = 1), SiteDataTable = sitedata_ex_multipletrmt[[1]], DailyClimateTable = climate_data)
optim(par = c(r_c = 0.5, hag = 0.1), fn = icbm_wrapper_example, method = "L-BFGS-B", lower = c(r_c = 0, hag = 0), upper = c(r_c = 1, hag = 1), SiteDataTable = sitedata_ex_multipletrmt[[1]], DailyClimateTable = climate_data)
#Debug
SiteDataTable = sitedata_ex_onesite
DailyClimateTable = climate_data
ag_init = 0
bg_init = 0
o_init = 0
irrigation_use_estimate = FALSE
alfa = 0.7
SoilTopThickness = 250
Temp_min = -3.78
Temp_max = 30
r_s = 0.42
r_wp = 0.18
ReferenceAdjustment = 0.10516
r_c = NA
tillage_soil = "Brown"
tillage_type = "Intensive Tillage"
irrigation_region = "Canada"
irrigation_use_estimate = FALSE
irrigation = 0
yield = filter(SiteDataTable, year_name == 1983)$total_yield
perennial = filter(SiteDataTable, year_name == 1983)$perennial
SoilOrganicC_Percent = filter(SiteDataTable, year_name == 1983)$soil_total_carbon_px
ClayContent = filter(SiteDataTable, year_name == 1983)$clay_px
SandContent = filter(SiteDataTable, year_name == 1983)$sand_px
result_ex_depth[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt[1:3] %>%
map(~head(.,3))
library(ggplot2)
library(knitr)
library(dplyr)
library(geojson)
library(tibble)
library(purrr)
library(stringr)
library(here)
library(lubridate)
library(tidyr)
dir.create(tempdir()) #This fixes a bug if the temporary directory is not found
here::i_am("walkthrough_icbm.rmd")
source(here::here("r/icbm_calculate_re.r"))
source(here::here("r/icbm_run.r"))
source(here::here("r/read_climate_data.r"))
source(here::here("r/gsa.r"))
# read SLC polygon IDs
polyids_all <- readr::read_csv(here("data/climate_data","Documentation", "SLC_PCPTREGION.csv"))
# read site data
sitedata_all <- readr::read_csv(here("data/all_experiments_dummy.csv")) %>%
left_join(polyids_all, by=c("latitude" = "Lat", "longitude" = "Long"))
sitedata_ex_onesite <- sitedata_all %>%
filter(location_name == "Ellerslie") %>%
filter(treatment_number == 7) %>%
filter(year_name <= 1985)
sitedata_ex_multipletrmt <- sitedata_all %>%
filter(year_name <= 1985) %>%
filter(location_name == "Ellerslie") %>%
group_by(treatment_name) %>%
group_split
sitedata_ex_multiplesite <- sitedata_all %>%
filter(year_name > 1990) %>%
filter(year_name < 2005) %>%
filter(team_name == "A") %>%
filter(location_name %in% c("Ellerslie", "Harrow")) %>%
group_by(location_name, treatment_name, replication_number) %>%
group_split
climate_data <- read_climate_data(climate_data_directory = here("data/climate_data","W9param_TablesCleaned"))
climate_data
head(sitedata_ex_onesite, 3)
result_ex_onesite <- run_icbm(
SiteDataTable = sitedata_ex_onesite,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0)
result_ex_onesite
sitedata_ex_multipletrmt[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt <- sitedata_ex_multipletrmt %>%
suppressWarnings() %>%
map(function(x) {
run_icbm(
SiteDataTable = x,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0)
}
)
result_ex_multipletrmt[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt <- sitedata_ex_multipletrmt %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
sitedata_ex_multiplesite[20:23] %>%
map(~head(.,3))
result_ex_multiplesite <- sitedata_ex_multiplesite %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
result_ex_multiplesite[20:23] %>%
map(~head(.,3))
sitedata_ex_error1 <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
group_by(location_name) %>%
group_split
try(sitedata_ex_error1 %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0)))
sitedata_ex_error1 %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_multiplesite %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_error2 <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
group_by(team_name, location_name, treatment_name, replication_number) %>%
group_split
sitedata_ex_error2 %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_depth <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
mutate(soil_depth = paste0(soil_depth_min_cm,"-",soil_depth_max_cm)) %>%
group_by(team_name, location_name, treatment_name, replication_number, plot_id, soil_depth) %>%
group_split
sitedata_ex_depth %>%
map(~any(duplicated(.$year_name))) %>%
unlist
result_ex_depth <- sitedata_ex_depth[1:10] %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
result_ex_depth[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt_override <- sitedata_ex_multipletrmt %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0,
# overrides
hag = 0.1))
result_ex_multipletrmt[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt_override[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt[[1]]
result_ex_multipletrmt[[1]]$Tot
result_ex_multipletrmt_override[[1]]$Tot
result_ex_multipletrmt[[1]]$Tot
tibble(Regular = result_ex_multipletrmt[[1]]$Tot,
Overridden = result_ex_multipletrmt_override[[1]]$Tot)
tibble(`Total SOC Regular` = result_ex_multipletrmt[[1]]$Tot,
`Total SOC Overridden` = result_ex_multipletrmt_override[[1]]$Tot)
tibble(Year = result_ex_multipletrmt[[1]]$time,
`Total SOC Regular` = result_ex_multipletrmt[[1]]$Tot,
`Total SOC Overridden` = result_ex_multipletrmt_override[[1]]$Tot)
library(ggplot2)
library(knitr)
library(dplyr)
library(geojson)
library(tibble)
library(purrr)
library(stringr)
library(here)
library(lubridate)
library(tidyr)
dir.create(tempdir()) #This fixes a bug if the temporary directory is not found
here::i_am("walkthrough_icbm.rmd")
source(here::here("r/icbm_calculate_re.r"))
source(here::here("r/icbm_run.r"))
source(here::here("r/read_climate_data.r"))
source(here::here("r/gsa.r"))
# read SLC polygon IDs
polyids_all <- readr::read_csv(here("data/climate_data","Documentation", "SLC_PCPTREGION.csv"))
# read site data
sitedata_all <- readr::read_csv(here("data/all_experiments_dummy.csv")) %>%
left_join(polyids_all, by=c("latitude" = "Lat", "longitude" = "Long"))
sitedata_ex_onesite <- sitedata_all %>%
filter(location_name == "Ellerslie") %>%
filter(treatment_number == 7) %>%
filter(year_name <= 1985)
sitedata_ex_multipletrmt <- sitedata_all %>%
filter(year_name <= 1985) %>%
filter(location_name == "Ellerslie") %>%
group_by(treatment_name) %>%
group_split
sitedata_ex_multiplesite <- sitedata_all %>%
filter(year_name > 1990) %>%
filter(year_name < 2005) %>%
filter(team_name == "A") %>%
filter(location_name %in% c("Ellerslie", "Harrow")) %>%
group_by(location_name, treatment_name, replication_number) %>%
group_split
climate_data <- read_climate_data(climate_data_directory = here("data/climate_data","W9param_TablesCleaned"))
climate_data
head(sitedata_ex_onesite, 3)
result_ex_onesite <- run_icbm(
SiteDataTable = sitedata_ex_onesite,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0)
result_ex_onesite
sitedata_ex_multipletrmt[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt <- sitedata_ex_multipletrmt %>%
suppressWarnings() %>%
map(function(x) {
run_icbm(
SiteDataTable = x,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0)
}
)
result_ex_multipletrmt[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt <- sitedata_ex_multipletrmt %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
sitedata_ex_multiplesite[20:23] %>%
map(~head(.,3))
result_ex_multiplesite <- sitedata_ex_multiplesite %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
result_ex_multiplesite[20:23] %>%
map(~head(.,3))
sitedata_ex_error1 <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
group_by(location_name) %>%
group_split
try(sitedata_ex_error1 %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0)))
sitedata_ex_error1 %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_multiplesite %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_error2 <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
group_by(team_name, location_name, treatment_name, replication_number) %>%
group_split
sitedata_ex_error2 %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_depth <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
mutate(soil_depth = paste0(soil_depth_min_cm,"-",soil_depth_max_cm)) %>%
group_by(team_name, location_name, treatment_name, replication_number, plot_id, soil_depth) %>%
group_split
sitedata_ex_depth %>%
map(~any(duplicated(.$year_name))) %>%
unlist
result_ex_depth <- sitedata_ex_depth[1:10] %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
result_ex_depth[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt_override <- sitedata_ex_multipletrmt %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0,
# overrides
hag = 0.1))
tibble(Year = result_ex_multipletrmt[[1]]$time,
`Total SOC Regular` = result_ex_multipletrmt[[1]]$Tot,
`Total SOC Overridden` = result_ex_multipletrmt_override[[1]]$Tot)
param_bounds <- read.csv(here("data/ipcct2_parameters_gsa.csv"), stringsAsFactors = FALSE)
sa_results <- gsa(sitedata_ex_onesite,
climate_data,
param_bounds)
sa_results
ex_func <- function(parameters) {
parameters["x"] + parameters["y"]
}
optim(par = c(x=-1.2,y=1), fn = ex_func, method = "L-BFGS-B", lower = c(x=0,y=1), upper = c(x=1,y=5))
icbm_wrapper_example <- function(parameters,
DailyClimateTable,
SiteDataTable,
ag_init = 0,
bg_init = 0,
o_init = 0,
...) {
args <- list(...)
inputs <- list(DailyClimateTable = DailyClimateTable,
SiteDataTable = SiteDataTable,
ag_init = ag_init,
bg_init = bg_init,
o_init = o_init) %>%
append(args) %>%
append(as.list(parameters))
model_results <- do.call(run_icbm,inputs)
mean_re <- mean(bind_rows(model_results)$re)
print(paste0(names(parameters),": ",parameters))
print(paste0("mean_re: ",mean_re))
return(mean_re)
}
icbm_wrapper_example(
parameters = c(r_c = 1),
SiteDataTable = sitedata_ex_multipletrmt[[1]],
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0
)
optim(par = c(r_c = 0.5), fn = icbm_wrapper_example, method = "L-BFGS-B", lower = c(r_c = 0), upper = c(r_c = 1), SiteDataTable = sitedata_ex_multipletrmt[[1]], DailyClimateTable = climate_data)
optim(par = c(r_c = 0.5, hag = 0.1), fn = icbm_wrapper_example, method = "L-BFGS-B", lower = c(r_c = 0, hag = 0), upper = c(r_c = 1, hag = 1), SiteDataTable = sitedata_ex_multipletrmt[[1]], DailyClimateTable = climate_data)
#Debug
SiteDataTable = sitedata_ex_onesite
DailyClimateTable = climate_data
ag_init = 0
bg_init = 0
o_init = 0
irrigation_use_estimate = FALSE
alfa = 0.7
SoilTopThickness = 250
Temp_min = -3.78
Temp_max = 30
r_s = 0.42
r_wp = 0.18
ReferenceAdjustment = 0.10516
r_c = NA
tillage_soil = "Brown"
tillage_type = "Intensive Tillage"
irrigation_region = "Canada"
irrigation_use_estimate = FALSE
irrigation = 0
yield = filter(SiteDataTable, year_name == 1983)$total_yield
perennial = filter(SiteDataTable, year_name == 1983)$perennial
SoilOrganicC_Percent = filter(SiteDataTable, year_name == 1983)$soil_total_carbon_px
ClayContent = filter(SiteDataTable, year_name == 1983)$clay_px
SandContent = filter(SiteDataTable, year_name == 1983)$sand_px
param_bounds
param_bounds <- read.csv(here("data/ipcct2_parameters_gsa.csv"), stringsAsFactors = FALSE)
param_bounds <- read.csv(here("data/ipcct2_parameters_gsa.csv"), stringsAsFactors = FALSE)
param_bounds
library(Metrics)
install.packages("Metrics")
library(Metrics)
library(Metrics)
library(ggplot2)
library(knitr)
library(dplyr)
library(geojson)
library(tibble)
library(purrr)
library(stringr)
library(here)
library(lubridate)
library(tidyr)
dir.create(tempdir()) #This fixes a bug if the temporary directory is not found
here::i_am("walkthrough_icbm.rmd")
source(here::here("r/icbm_calculate_re.r"))
source(here::here("r/icbm_run.r"))
source(here::here("r/read_climate_data.r"))
source(here::here("r/gsa.r"))
