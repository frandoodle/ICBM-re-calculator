# overrides
hag = 0.1))
tibble(Year = result_ex_multipletrmt[[1]]$time,
`Total SOC Regular` = result_ex_multipletrmt[[1]]$Tot,
`Total SOC Overridden` = result_ex_multipletrmt_override[[1]]$Tot)
spinup_sitedata_ex_onesite <- sitedata_ex_onesite %>%
slice(1:10)
spinup_ex_onesite <- spinup(site_data = spinup_sitedata_ex_onesite,
climate_data = climate_data,
initial_c = 1000,
model = "ipcct2")
source(here::here("r/spinup.r"))
library(ggplot2)
library(knitr)
library(dplyr)
library(geojson)
library(tibble)
library(purrr)
library(stringr)
library(here)
library(lubridate)
library(tidyr)
dir.create(tempdir()) #This fixes a bug if the temporary directory is not found
here::i_am("walkthrough_icbm.rmd")
source(here::here("r/icbm_calculate_re.r"))
source(here::here("r/icbm_run.r"))
source(here::here("r/read_climate_data.r"))
source(here::here("r/spinup.r"))
source(here::here("r/bayesian_gsa.r"))
source(here::here("r/bayesian_sir.r"))
source(here::here("r/bayesian_uncertainty.r"))
# read SLC polygon IDs
polyids_all <- readr::read_csv(here("data/climate_data","Documentation", "SLC_PCPTREGION.csv"))
# read site data
sitedata_all <- readr::read_csv(here("data/all_experiments_dummy.csv")) %>%
left_join(polyids_all, by=c("latitude" = "Lat", "longitude" = "Long"))
sitedata_ex_onesite <- sitedata_all %>%
filter(location_name == "Ellerslie") %>%
filter(treatment_number == 7) %>%
filter(year_name <= 1985)
sitedata_ex_multipletrmt <- sitedata_all %>%
filter(year_name <= 1985) %>%
filter(location_name == "Ellerslie") %>%
group_by(treatment_name) %>%
group_split
sitedata_ex_multiplesite <- sitedata_all %>%
filter(year_name > 1990) %>%
filter(year_name < 2005) %>%
filter(team_name == "A") %>%
filter(location_name %in% c("Ellerslie", "Harrow")) %>%
group_by(location_name, treatment_name, replication_number) %>%
group_split
climate_data <- read_climate_data(climate_data_directory = here("data/climate_data","W9param_TablesCleaned"))
climate_data
head(sitedata_ex_onesite, 3)
result_ex_onesite <- run_icbm(
SiteDataTable = sitedata_ex_onesite,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0)
result_ex_onesite
sitedata_ex_multipletrmt[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt <- sitedata_ex_multipletrmt %>%
suppressWarnings() %>%
map(function(x) {
run_icbm(
SiteDataTable = x,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0)
}
)
result_ex_multipletrmt[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt <- sitedata_ex_multipletrmt %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
sitedata_ex_multiplesite[21:23] %>%
map(~head(.,3))
result_ex_multiplesite <- sitedata_ex_multiplesite %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
result_ex_multiplesite[21:23] %>%
map(~head(.,3))
sitedata_ex_error1 <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
group_by(location_name) %>%
group_split
try(sitedata_ex_error1 %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0)))
sitedata_ex_error1 %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_multiplesite %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_error2 <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
group_by(team_name, location_name, treatment_name, replication_number) %>%
group_split
sitedata_ex_error2 %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_depth <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
mutate(soil_depth = paste0(soil_depth_min_cm,"-",soil_depth_max_cm)) %>%
group_by(team_name, location_name, treatment_name, replication_number, plot_id, soil_depth) %>%
group_split
sitedata_ex_depth %>%
map(~any(duplicated(.$year_name))) %>%
unlist
result_ex_depth <- sitedata_ex_depth[1:10] %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
result_ex_depth[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt_override <- sitedata_ex_multipletrmt %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0,
# overrides
hag = 0.1))
tibble(Year = result_ex_multipletrmt[[1]]$time,
`Total SOC Regular` = result_ex_multipletrmt[[1]]$Tot,
`Total SOC Overridden` = result_ex_multipletrmt_override[[1]]$Tot)
spinup_sitedata_ex_onesite <- sitedata_ex_onesite %>%
slice(1:10)
spinup_ex_onesite <- spinup(site_data = spinup_sitedata_ex_onesite,
climate_data = climate_data,
initial_c = 1000,
model = "ipcct2")
spinup_ex_onesite
run_ipcct2(
site_data = sitedata_ex_onesite,
climate_data = climate_data,
init_active = spinup_ex_onesite$init_active,
init_slow = spinup_ex_onesite$init_slow,
init_passive = spinup_ex_onesite$init_passive)
spinup_sitedata_ex_multipletrmt <- sitedata_ex_multipletrmt %>%
map(~slice(., 1:10))
# Note: this is just an example. The column total_yield has nothing to do with initial C values.
initial_c_ex_multipletrmt <- sitedata_ex_multipletrmt %>%
map(~.$total_yield[1])
initial_c_ex_multipletrmt
spinup_ex_multipletrmt <- map2(.x = spinup_sitedata_ex_multipletrmt,
.y = initial_c_ex_multipletrmt,
~spinup(site_data = .x,
climate_data = climate_data,
initial_c = .y,
model = "ipcct2"))
spinup_ex_multipletrmt
sitedata_ex_multipletrmt %>%
map2(spinup_ex_multipletrmt,
~run_ipcct2(site_data = .x,
climate_data = climate_data,
initial_c = .y))
param_bounds <- read.csv(here("data/ipcct2_parameters_gsa.csv"), stringsAsFactors = FALSE)
param_bounds
sa_ex_onesite_sj <- gsa(site_data = sitedata_ex_onesite,
climate_data = climate_data,
initial_c = spinup_ex_onesite,
parameter_bounds = param_bounds,
sample_size = 10,
method = "soboljansen")
sa_ex_onesite_sj
sa_ex_onesite_f99 <- gsa(site_data = sitedata_ex_onesite,
climate_data = climate_data,
initial_c = spinup_ex_onesite,
parameter_bounds = param_bounds,
sample_size = 100,
method = "fast99")
library(ggplot2)
library(knitr)
library(dplyr)
library(geojson)
library(tibble)
library(purrr)
library(stringr)
library(here)
library(lubridate)
library(tidyr)
dir.create(tempdir()) #This fixes a bug if the temporary directory is not found
here::i_am("walkthrough_icbm.rmd")
source(here::here("r/icbm_calculate_re.r"))
source(here::here("r/icbm_run.r"))
source(here::here("r/read_climate_data.r"))
source(here::here("r/spinup.r"))
source(here::here("r/bayesian_gsa.r"))
source(here::here("r/bayesian_sir.r"))
source(here::here("r/bayesian_uncertainty.r"))
# read SLC polygon IDs
polyids_all <- readr::read_csv(here("data/climate_data","Documentation", "SLC_PCPTREGION.csv"))
# read site data
sitedata_all <- readr::read_csv(here("data/all_experiments_dummy.csv")) %>%
left_join(polyids_all, by=c("latitude" = "Lat", "longitude" = "Long"))
sitedata_ex_onesite <- sitedata_all %>%
filter(location_name == "Ellerslie") %>%
filter(treatment_number == 7) %>%
filter(year_name <= 1985)
sitedata_ex_multipletrmt <- sitedata_all %>%
filter(year_name <= 1985) %>%
filter(location_name == "Ellerslie") %>%
group_by(treatment_name) %>%
group_split
sitedata_ex_multiplesite <- sitedata_all %>%
filter(year_name > 1990) %>%
filter(year_name < 2005) %>%
filter(team_name == "A") %>%
filter(location_name %in% c("Ellerslie", "Harrow")) %>%
group_by(location_name, treatment_name, replication_number) %>%
group_split
climate_data <- read_climate_data(climate_data_directory = here("data/climate_data","W9param_TablesCleaned"))
climate_data
head(sitedata_ex_onesite, 3)
result_ex_onesite <- run_icbm(
SiteDataTable = sitedata_ex_onesite,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0)
result_ex_onesite
sitedata_ex_multipletrmt[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt <- sitedata_ex_multipletrmt %>%
suppressWarnings() %>%
map(function(x) {
run_icbm(
SiteDataTable = x,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0)
}
)
result_ex_multipletrmt[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt <- sitedata_ex_multipletrmt %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
sitedata_ex_multiplesite[21:23] %>%
map(~head(.,3))
result_ex_multiplesite <- sitedata_ex_multiplesite %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
result_ex_multiplesite[21:23] %>%
map(~head(.,3))
sitedata_ex_error1 <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
group_by(location_name) %>%
group_split
try(sitedata_ex_error1 %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0)))
sitedata_ex_error1 %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_multiplesite %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_error2 <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
group_by(team_name, location_name, treatment_name, replication_number) %>%
group_split
sitedata_ex_error2 %>%
map(~any(duplicated(.$year_name))) %>%
unlist
sitedata_ex_depth <- sitedata_all %>%
filter(team_name == "B") %>%
filter(year_name >= 1981) %>%
mutate(soil_depth = paste0(soil_depth_min_cm,"-",soil_depth_max_cm)) %>%
group_by(team_name, location_name, treatment_name, replication_number, plot_id, soil_depth) %>%
group_split
sitedata_ex_depth %>%
map(~any(duplicated(.$year_name))) %>%
unlist
result_ex_depth <- sitedata_ex_depth[1:10] %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0))
result_ex_depth[1:3] %>%
map(~head(.,3))
result_ex_multipletrmt_override <- sitedata_ex_multipletrmt %>%
map(~run_icbm(
SiteDataTable = .,
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0,
# overrides
hag = 0.1))
tibble(Year = result_ex_multipletrmt[[1]]$time,
`Total SOC Regular` = result_ex_multipletrmt[[1]]$Tot,
`Total SOC Overridden` = result_ex_multipletrmt_override[[1]]$Tot)
spinup_sitedata_ex_onesite <- sitedata_ex_onesite %>%
slice(1:10)
spinup_ex_onesite <- spinup(site_data = spinup_sitedata_ex_onesite,
climate_data = climate_data,
initial_c = 1000,
model = "ipcct2")
spinup_ex_onesite
run_ipcct2(
site_data = sitedata_ex_onesite,
climate_data = climate_data,
init_active = spinup_ex_onesite$init_active,
init_slow = spinup_ex_onesite$init_slow,
init_passive = spinup_ex_onesite$init_passive)
spinup_sitedata_ex_multipletrmt <- sitedata_ex_multipletrmt %>%
map(~slice(., 1:10))
# Note: this is just an example. The column total_yield has nothing to do with initial C values.
initial_c_ex_multipletrmt <- sitedata_ex_multipletrmt %>%
map(~.$total_yield[1])
initial_c_ex_multipletrmt
spinup_ex_multipletrmt <- map2(.x = spinup_sitedata_ex_multipletrmt,
.y = initial_c_ex_multipletrmt,
~spinup(site_data = .x,
climate_data = climate_data,
initial_c = .y,
model = "ipcct2"))
spinup_ex_multipletrmt
sitedata_ex_multipletrmt %>%
map2(spinup_ex_multipletrmt,
~run_ipcct2(site_data = .x,
climate_data = climate_data,
initial_c = .y))
param_bounds <- read.csv(here("data/ipcct2_parameters_gsa.csv"), stringsAsFactors = FALSE)
param_bounds
sa_ex_onesite_sj <- gsa(site_data = sitedata_ex_onesite,
climate_data = climate_data,
initial_c = spinup_ex_onesite,
parameter_bounds = param_bounds,
sample_size = 10,
method = "soboljansen")
sa_ex_onesite_sj
sa_ex_onesite_f99 <- gsa(site_data = sitedata_ex_onesite,
climate_data = climate_data,
initial_c = spinup_ex_onesite,
parameter_bounds = param_bounds,
sample_size = 100,
method = "fast99")
sa_ex_onesite_f99
ggplot(sa_ex_onesite_f99)+
geom_bar(aes(x=reorder(params, interactions), y=main),stat='identity',
fill="black") +
geom_bar(aes(x=reorder(params, interactions), y=interactions),
stat='identity', fill="grey",alpha=0.7 ) +
coord_flip() +
theme_bw()
sa_ex_multipletrmt <- gsa(site_data = sitedata_ex_multipletrmt,
climate_data = climate_data,
initial_c = spinup_ex_multipletrmt,
parameter_bounds = param_bounds,
sample_size = 10)
sa_ex_multipletrmt
# First-order sensitivity
ggplot(sa_ex_multipletrmt, aes(x = reorder(params, -singsi), y = singsi, ymax=singsi.uci, ymin=singsi.lci)) +
xlab("Parameters") +
ylab("First-Order Sensitivity Index") +
geom_errorbar(width=0.2, size=1, color="black") +
geom_bar(stat='identity', fill="grey", alpha=0.70 ) +
coord_flip() +
theme_bw()
# Total order sensitivity
ggplot(sa_ex_multipletrmt, aes(x = reorder(params, -singsi), y = totsi, ymax=totsi.uci, ymin=totsi.lci))+
xlab("Parameters") +
ylab("Total-Order Sensitivity Index") +
geom_errorbar(width=0.2, size=1, color="black")+
geom_bar(stat='identity', fill="grey", alpha=0.70) +
coord_flip() +
theme_bw()
# Both
ggplot(sa_ex_multipletrmt, aes(x = reorder(params, -singsi), y = totsi, ymax=totsi.uci, ymin=totsi.lci)) +
geom_bar(aes(y = singsi), stat='identity', fill="black", alpha=0.7)+
geom_bar(aes(y = totsi), stat='identity', fill="grey", alpha=0.7)+
geom_errorbar(width=0.2, size=1)+
coord_flip() +
theme_bw()
param_bounds
sa_ex_onesite_sj
sir_ex_multipletrmt <- sir(site_data = sitedata_ex_multipletrmt,
climate_data = climate_data,
initial_c = spinup_ex_multipletrmt,
parameter_bounds = param_bounds,
sample_size = 100,
resample_size = 10)
sir_ex_multipletrmt
prior <- sir_ex_multipletrmt$prior %>%
pivot_longer(cols = !`SampleID`)
posterior <- sir_ex_multipletrmt$posterior %>%
pivot_longer(cols = !`SampleID`)
ggplot() +
geom_density(data = posterior, aes(value), col = NA, fill = "red", alpha = 0.2) +
geom_density(data = prior, aes(value), col = NA, fill = "blue", alpha = 0.2) +
facet_wrap(~name, scales = "free", ncol = 3) +
theme_bw() +
theme(panel.border = element_rect(colour = "black", fill = NA), panel.grid.major = element_blank(),
axis.title.x=element_blank(),panel.grid.minor = element_blank()) +
scale_y_continuous(expand = c(0,0)) + scale_x_continuous(expand = c(0,0))
uncertainty_ex_multipletrmt <- montecarlo(site_data = sitedata_ex_multipletrmt,
climate_data = climate_data,
initial_c = spinup_ex_multipletrmt,
distribution = sir_ex_multipletrmt$posterior,
sample_size = 10)
uncertainty_ex_multipletrmt
ggplot(data = NULL, aes(x=soc_total/10, y=soc_tha*(30/(soil_depth_max_cm - soil_depth_min_cm)))) +
geom_point(data=uncertainty_ex_multipletrmt$montecarlo, color = "grey") +
geom_point(data=uncertainty_ex_multipletrmt$median, color="black") +
geom_abline(intercept = 0, slope = 1) +
coord_fixed(ratio = 1, xlim = c(0,400), ylim = c(0,400), expand = TRUE, clip="off") +
theme_bw()
ex_func <- function(parameters) {
parameters["x"] + parameters["y"]
}
optim(par = c(x=-1.2,y=1), fn = ex_func, method = "L-BFGS-B", lower = c(x=0,y=1), upper = c(x=1,y=5))
icbm_wrapper_example <- function(parameters,
DailyClimateTable,
SiteDataTable,
ag_init = 0,
bg_init = 0,
o_init = 0,
...) {
args <- list(...)
inputs <- list(DailyClimateTable = DailyClimateTable,
SiteDataTable = SiteDataTable,
ag_init = ag_init,
bg_init = bg_init,
o_init = o_init) %>%
append(args) %>%
append(as.list(parameters))
model_results <- do.call(run_icbm,inputs)
mean_re <- mean(bind_rows(model_results)$re)
print(paste0(names(parameters),": ",parameters))
print(paste0("mean_re: ",mean_re))
return(mean_re)
}
icbm_wrapper_example(
parameters = c(r_c = 1),
SiteDataTable = sitedata_ex_multipletrmt[[1]],
DailyClimateTable = climate_data,
ag_init = 0,
bg_init = 0,
o_init = 0
)
optim(par = c(r_c = 0.5), fn = icbm_wrapper_example, method = "L-BFGS-B", lower = c(r_c = 0), upper = c(r_c = 1), SiteDataTable = sitedata_ex_multipletrmt[[1]], DailyClimateTable = climate_data)
optim(par = c(r_c = 0.5, hag = 0.1), fn = icbm_wrapper_example, method = "L-BFGS-B", lower = c(r_c = 0, hag = 0), upper = c(r_c = 1, hag = 1), SiteDataTable = sitedata_ex_multipletrmt[[1]], DailyClimateTable = climate_data)
#Debug
SiteDataTable = sitedata_ex_onesite
DailyClimateTable = climate_data
ag_init = 0
bg_init = 0
o_init = 0
irrigation_use_estimate = FALSE
alfa = 0.7
SoilTopThickness = 250
Temp_min = -3.78
Temp_max = 30
r_s = 0.42
r_wp = 0.18
ReferenceAdjustment = 0.10516
r_c = NA
tillage_soil = "Brown"
tillage_type = "Intensive Tillage"
irrigation_region = "Canada"
irrigation_use_estimate = FALSE
irrigation = 0
yield = filter(SiteDataTable, year_name == 1983)$total_yield
perennial = filter(SiteDataTable, year_name == 1983)$perennial
SoilOrganicC_Percent = filter(SiteDataTable, year_name == 1983)$soil_total_carbon_px
ClayContent = filter(SiteDataTable, year_name == 1983)$clay_px
SandContent = filter(SiteDataTable, year_name == 1983)$sand_px
