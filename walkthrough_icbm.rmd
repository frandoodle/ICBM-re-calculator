---
title: "Running ICBM"
author: "Francis Durnin-Vermette"
date: "2022/12/19"
output:
  html_notebook:
    toc: true
    number_sections: true
    df_print: paged
bibliography: re.bib
editor_options:
  chunk_output_type: inline
---

```{r include=FALSE}

library(ggplot2)
library(knitr)
library(dplyr)
library(geojson)
library(tibble)
library(purrr)
library(stringr)
library(here)
library(lubridate)
library(tidyr)

dir.create(tempdir()) #This fixes a bug if the temporary directory is not found

here::i_am("walkthrough_icbm.rmd")
source(here::here("re_script.r"))
source(here::here("re_functions.r"))
source(here::here("run_icbm_and_re.r"))
source(here::here("get_climate_data.r"))

```


# Quick Start - ICBM + r~e~ Calculator
In order to run ICBM simulations that include the calculated r~e~ parameter from climate data, you can use the function `RunICBMAndRe` from the script `run_icbm_and_re.r`. The definitions of every input are given in the header of that script. The function returns the same output as the ICBM function `icbm_holos4_classic_manure`; a table with ICBM C pools for every year, as well as the yearly mean r~e~ value.

```{r}
locdata <- readr::read_csv("all_experiments_dummy.csv")
sitedat <- getSiteData(locdata, "Ellerslie")
```

## Importing climate data using `getClimateData()`
The climate data should have these mandatory columns: `Year`, `JulianDay`, `Tavg`, which is the mean daily air temperature, `PREC`, which is the mean daily precipitation, and `PET`, which is the mean daily PET.

Note: use the `suppressWarnings` function to run a function without any warnings
(e.g. `suppressWarnings(run_icbm_and_re.r())`).

```{r}
# Import climate data
get_climate_data_example <- getClimateData(
	climate_data_folder = "climate_data",
	master_data_folder = "master",
	site_name = "244014")
```


## Running ICBM

```{r}
site_data_treatment <- sitedat %>%
	filter(treatment_number == 7) %>%
	filter(year_name <= 1985)

result <- RunICBMAndRe(
	SiteDataTable = site_data_treatment,
	DailyClimateTable = get_climate_data_example,
	ag_init = 0,
	bg_init = 0,
	o_init = 0,
	irrigation_use_estimate = FALSE)
```
